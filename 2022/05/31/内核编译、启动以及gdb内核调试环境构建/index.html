<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="mufiye">
    
    <title>
        
            内核编译、启动以及gdb内核调试环境构建 |
        
        mufiye&#39;s blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/logo.png">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/css/font-awesome.min.css">
    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"zh-CN","path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066CC","avatar":"/images/happy.jpg","favicon":"/images/logo.png","article_img_align":"center","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":true,"scale":false},"first_screen":{"enable":false,"background_img":"/images/bg.svg","description":"Keep writing and Keep loving."},"scroll":{"progress_bar":{"enable":true},"percent":{"enable":false}}},"local_search":{"enable":true,"preload":true},"code_copy":{"enable":true,"style":"default"},"pjax":{"enable":false},"lazyload":{"enable":false},"version":"3.4.5"};
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"};
  </script>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.2.0"></head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                mufiye&#39;s blog
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                首页
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                归档
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                分类
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                标签
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                关于
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">首页</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">归档</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">分类</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">标签</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">关于</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">内核编译、启动以及gdb内核调试环境构建</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/happy.jpg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">mufiye</span>
                        
                            <span class="author-label">内核新手</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2022-05-31 16:58:17</span>
        <span class="mobile">2022-05-31 16:58</span>
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%86%85%E6%A0%B8/">操作系统内核</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/gdb/">gdb</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">环境搭建</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/%E5%86%85%E6%A0%B8%E7%BC%96%E8%AF%91/">内核编译</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/qemu/">qemu</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>3.3k 字</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>14 分钟</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <h1 id="1-相关软件包环境以及目录结构"><a href="#1-相关软件包环境以及目录结构" class="headerlink" title="1. 相关软件包环境以及目录结构"></a>1. 相关软件包环境以及目录结构</h1><p><strong>Qemu：</strong>QEMU emulator version 6.2.0 (Debian 1:6.2+dfsg-2ubuntu6)</p>
<p><strong>GDB：</strong>GNU gdb (Ubuntu 12.0.90-0ubuntu1) 12.0.90</p>
<p><strong>提示：</strong>在编译内核时可能需要安装其它软件包，根据提示安装即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mufiye_kernel(workspace)</span><br><span class="line">	---- kernel-OLK-5.10(openEuler kernel source code)</span><br><span class="line">	---- linux-kernel(linux kernel source code)</span><br><span class="line">	---- rootfs(store image)</span><br><span class="line">		---- base_img</span><br><span class="line">			---- create_image.sh</span><br><span class="line">			---- update-image.sh</span><br><span class="line">			---- create-qcow2.sh</span><br><span class="line">		---- 2.bullseye</span><br><span class="line">		---- 3.bullseye3</span><br></pre></td></tr></table></figure>
<h1 id="2-编译内核"><a href="#2-编译内核" class="headerlink" title="2. 编译内核"></a>2. 编译内核</h1><ol>
<li><p><a class="link" target="_blank" rel="noopener" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git">linux kernel git repo<i class="fas fa-external-link-alt"></i></a>：本次编译使用的是该源码，版本为<strong>5.18-rc7</strong></p>
</li>
<li><p>应用该<a class="link" target="_blank" rel="noopener" href="https://github.com/mufiye/mufiye_backup/blob/master/kernel_environment/0001-x86_64-debug.patch">patch<i class="fas fa-external-link-alt"></i></a>使debug更方便（直接使用git am或对照修改）</p>
</li>
<li><p>config</p>
</li>
</ol>
<ul>
<li><p>清理旧的编译生成的文件及其他配置等文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make mrproper</span><br></pre></td></tr></table></figure>
</li>
<li><p>首先生成.config（运行make menuconfig后直接save）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make menuconfig</span><br></pre></td></tr></table></figure>
</li>
<li><p>根据该<a class="link" target="_blank" rel="noopener" href="https://github.com/mufiye/mufiye_backup/blob/master/kernel_environment/config">config<i class="fas fa-external-link-alt"></i></a>修改.config文件</p>
</li>
<li><p>一些关于gdb调试的内核CONFIG选项：</p>
<p>需要注意的是CONFIG_DEBUG_INFO_DWARF_TOOLCHAIN_DEFAULT配置选项，5.12版本的linux内核新增了DEBUG_INFO_DWARF5配置选项，而5.18版本后DEBUG_INFO配置需要设置开启DEBUG_INFO_DWARF4和DEBUG_INFO_DWARF5中的一个。DWARF为调试信息格式，而DEBUG_INFO_DWARF4配置选项和DEBUG_INFO_DWARF5配置选项的区别是使用哪个版本的调试信息格式，v5版本拥有更优的数据压缩、更快的符号搜索能力以及其调试信息可以从可执行文件中分离出来，但是v5版本相比v4版本需要更高版本的工具链(gcc，gdb等)支持，因此我们设置DEBUG_INFO_DWARF_TOOLCHAIN_DEFAULT配置选项使其根据工具链决定使用的DWARF版本。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_KGDB=y</span><br><span class="line">CONFIG_DEBUG_BUGVERBOSE=y</span><br><span class="line">CONFIG_DEBUG_SECTION_MISMATCH=y  # 防止内联</span><br><span class="line">CONFIG_DEBUG_INFO=y</span><br><span class="line">CONFIG_DEBUG_INFO_DWARF_TOOLCHAIN_DEFAULT=y  # 新版本特性</span><br><span class="line">CONFIG_DEBUG_KERNEL=y</span><br><span class="line">CONFIG_FRAME_POINTER=y  # Makefile中选择GCC编译选项</span><br><span class="line">CONFIG_GDB_SCRIPTS=y  # gdb python</span><br><span class="line"># 关闭CONFIG_DEBUG_RODATA</span><br><span class="line"># 关闭CONFIG_DEBUG_INFO_REDUCED</span><br><span class="line"># 关闭CONFIG_RANDOMIZE_BASE</span><br></pre></td></tr></table></figure></li>
</ul>
<ol start="4">
<li><p>进行编译，先编译内核镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make bzImage -j16</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make modules -j16</span><br></pre></td></tr></table></figure>
</li>
<li><p>进行模块安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">INSTALL_MOD_PATH表示模块安装的位置</span></span><br><span class="line">make modules_install INSTALL_MOD_PATH=mod -j16</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="3-制作根文件系统"><a href="#3-制作根文件系统" class="headerlink" title="3. 制作根文件系统"></a>3. 制作根文件系统</h1><p>该节主要讲述如何制作根文件系统。</p>
<ol>
<li><p>安装debootstrap</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install debootstrap</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用<a class="link" target="_blank" rel="noopener" href="https://github.com/mufiye/mufiye_backup/blob/master/kernel_environment/create-image.sh">create-image.sh<i class="fas fa-external-link-alt"></i></a>创建镜像，create-image.sh用于创建一个适合syzkaller的最小Debian镜像。由于create-image.sh脚本文件过长，我提炼出其中的核心语句列出并做了注释（适用于x86_64）。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash ./create-image.sh</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/env bash</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">一些预安装的软件包</span></span><br><span class="line">PREINSTALL_PKGS=openssh-server,curl,tar,gcc，...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认的安装变量</span></span><br><span class="line">ARCH=x86_64</span><br><span class="line">DEBARCH=amd64</span><br><span class="line">RELEASE=bullseye</span><br><span class="line">FEATURE=minimal</span><br><span class="line">SEEK=16383</span><br><span class="line">PERF=false</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">略过了读取参数和一些相关设置，直接采用默认设置尽快进入主体代码</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装目录</span></span><br><span class="line">DIR=chroot</span><br><span class="line">sudo rm -rf $DIR</span><br><span class="line">sudo mkdir -p $DIR</span><br><span class="line">sudo chmod 0755 $DIR</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">debootstrap将Debian基础系统安装到另一个已安装系统的子目录中</span>  </span><br><span class="line">DEBOOTSTRAP_PARAMS=&quot;--arch=$DEBARCH --include=$PREINSTALL_PKGS -components=main,contrib,non-free $RELEASE $DIR&quot;</span><br><span class="line">sudo debootstrap $DEBOOTSTRAP_PARAMS https://repo.huaweicloud.com/debian/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这堆<span class="built_in">echo</span>用于设定debian系统的一些参数，<span class="built_in">tee</span>用于重定向</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">找到root对应的行并将密码设置为空，x表示密码，但是这里不显示</span></span><br><span class="line">sudo sed -i &#x27;/^root/ &#123; s/:x:/::/ &#125;&#x27; $DIR/etc/passwd</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">内核初始化时会读取/etc/inittab文件，每个条目的格式为<span class="built_in">id</span>:runlevels:action:process，其中<span class="built_in">id</span>为条目编号，runlevels表示运行级别，action表示要执行的动作，process表示要执行的程序，respawn的意思就是当后面的要执行的程序终止了，init进程会自动重启该进程。该命令使系统启动getty并提供登录提示到终端。</span></span><br><span class="line">echo &#x27;T0:23:respawn:/sbin/getty -L ttyS0 115200 vt100&#x27; | sudo tee -a $DIR/etc/inittab</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置网络</span></span><br><span class="line">printf &#x27;\nauto eth0\niface eth0 inet dhcp\n&#x27; | sudo tee -a $DIR/etc/network/interfaces</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置挂载信息</span></span><br><span class="line">echo &#x27;/dev/root / ext4 defaults 0 0&#x27; | sudo tee -a $DIR/etc/fstab</span><br><span class="line">echo &#x27;debugfs /sys/kernel/debug debugfs defaults 0 0&#x27; | sudo tee -a $DIR/etc/fstab</span><br><span class="line">echo &#x27;securityfs /sys/kernel/security securityfs defaults 0 0&#x27; | sudo tee -a $DIR/etc/fstab</span><br><span class="line">echo &#x27;configfs /sys/kernel/config/ configfs defaults 0 0&#x27; | sudo tee -a $DIR/etc/fstab</span><br><span class="line">echo &#x27;binfmt_misc /proc/sys/fs/binfmt_misc binfmt_misc defaults 0 0&#x27; | sudo tee -a $DIR/etc/fstab</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置域名解析文件</span></span><br><span class="line">echo -en &quot;127.0.0.1\tlocalhost\n&quot; | sudo tee $DIR/etc/hosts</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置域名解析服务器号</span></span><br><span class="line">echo &quot;nameserver 8.8.8.8&quot; | sudo tee -a $DIR/etc/resolve.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置主机名为syzkaller</span></span><br><span class="line">echo &quot;syzkaller&quot; | sudo tee $DIR/etc/hostname</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建并设置ssh密钥</span></span><br><span class="line">ssh-keygen -f $RELEASE.id_rsa -t rsa -N &#x27;&#x27;</span><br><span class="line">sudo mkdir -p $DIR/root/.ssh/</span><br><span class="line">cat $RELEASE.id_rsa.pub | sudo tee $DIR/root/.ssh/authorized_keys</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">为vim2m驱动程序管理的设备创建一个/dev/vim2m符号链接，与syzkaller有关</span></span><br><span class="line">echo &#x27;ATTR&#123;name&#125;==&quot;vim2m&quot;, SYMLINK+=&quot;vim2m&quot;&#x27; | sudo tee -a $DIR/etc/udev/rules.d/50-udev-default.rules</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建虚拟化硬盘，块大小为1M，seek指定把块输出到文件时要跳过多少个块，count指定拷贝的块数，此时img中为空字符（因为/dev/zero）</span></span><br><span class="line">dd if=/dev/zero of=$RELEASE.img bs=1M seek=$SEEK count=1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将镜像格式化为ext4文件系统</span></span><br><span class="line">sudo mkfs.ext4 -F $RELEASE.img</span><br><span class="line">sudo mkdir -p /mnt/$DIR</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">挂载环回设备，此时该img被挂载，就像普通设备一样</span></span><br><span class="line">sudo mount -o loop $RELEASE.img /mnt/$DIR</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将之前创建的系统的内容拷贝到img中</span></span><br><span class="line">sudo cp -a $DIR/. /mnt/$DIR/.</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">取消挂载</span></span><br><span class="line">sudo umount /mnt/$DIR</span><br></pre></td></tr></table></figure>
</li>
<li><p>移除生成的一些无用文件（密钥文件）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm bullseye.id_rsa*</span><br></pre></td></tr></table></figure>
</li>
<li><p>将img文件转换为.qcow2文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-img convert -p -f raw -O qcow2 bullseye.img bullseye.qcow2</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="4-安装并且配置qemu"><a href="#4-安装并且配置qemu" class="headerlink" title="4. 安装并且配置qemu"></a>4. 安装并且配置qemu</h1><ol>
<li><p>安装qemu</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install qemu-system</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动qemu前的准备（可以先直接到第3步试一试，不行再做这里的尝试）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装一些网络相关的包：</span></span><br><span class="line">sudo apt-get install qemu-kvm virt-manager bridge-utils</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改/etc/qemu/bridge.conf</span></span><br><span class="line">mkdir -p /etc/qemu #如果没有qemu文件夹</span><br><span class="line">sudo vim /etc/qemu/bridge.conf #第一行加入 allow virbr0</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对/etc/ssh/sshd_config修改以下内容:</span></span><br><span class="line">PermitRootLogin yes #允许root用户登录</span><br><span class="line">PasswordAuthentication yes #开启密码认证</span><br><span class="line">PermitEmptyPasswords yes #允许密码为空</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">非root用户没有权限的解决办法</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">不同qemu可能qemu-bridge-helper位置不一样</span></span><br><span class="line">sudo find / -name qemu-bridge-helper # 先用这个命令确定文件的位置</span><br><span class="line">sudo chown root /usr/lib/qemu/qemu-bridge-helper # 将该文件的所有者改为root</span><br><span class="line">sudo chmod u+s /usr/lib/qemu/qemu-bridge-helper # setuid位为1表示设置使文件在执行阶段具有文件所有者的权限，该命令设置setuid位为1，setuid位占用属主执行位</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行<a class="link" target="_blank" rel="noopener" href="https://github.com/mufiye/mufiye_backup/blob/master/kernel_environment/update-image.sh">update_image.sh<i class="fas fa-external-link-alt"></i></a>来启动qemu</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kernel version表示的是内核源码的目录</span></span><br><span class="line">kernel_version=linux-kernel</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-enable-kvm表示允许启用KVM,linux内核和硬件必须支持KVM并且加载kvm内核模块</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-smp设置虚拟机的cpu数量，这里设置为16</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-m表示设置虚拟机内存大小，这里设置为2G</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-kernel指向启动qemu的内核镜像</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-virtfs用于创建共享目录（虚拟机与物理机之间）</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-nographic表示禁用图形输出并将串行I/O重定向到控制台，vga用于选择显卡类型</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-append设置Linux内核命令行、启动参数，“console=ttyS0”表示把QEMU的输入输出定向到当前终端上，“root”指示根文件系统，<span class="string">&quot;nokaslr&quot;</span>表示关闭KASRL，KASRL使内核地址空间布局随机化，这会让gdb难以调试</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-device为设备设置驱动程序属性，-drive指定和标识该设备。如在该虚拟机启动项中，virtio-blk表示了驱动属性；用于此驱动设备的磁盘映像的路径为bullseye.qcow2，其文件格式为qcow2；缓存方式使用回写，也就是调用write写入数据时只将数据写入到磁盘缓存中，当数据被换出缓存时才写入到后端存储中；<span class="built_in">id</span>为root，-device drive使连接到该<span class="built_in">id</span>为root的设备。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-net nic创建一个网卡，并设置mac地址</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-net bridge创建一个网桥</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">-enable-kvm \</span><br><span class="line">-smp 16 \</span><br><span class="line">-m 2G \</span><br><span class="line">-kernel /home/mufiye/mufiye_kernel/$&#123;kernel_version&#125;/arch/x86/boot/bzImage \</span><br><span class="line">-virtfs local,id=kmod_dev,path=/home/mufiye/mufiye_kernel/$&#123;kernel_version&#125;/mod,readonly,mount_tag=9p,security_model=none \</span><br><span class="line">-vga none \</span><br><span class="line">-nographic \</span><br><span class="line">-append &quot;nokaslr console=ttyS0 root=/dev/vda rw kmemleak=on&quot; \</span><br><span class="line">-device virtio-scsi-pci \</span><br><span class="line">-drive file=bullseye.qcow2,if=none,format=qcow2,cache=writeback,file.locking=off,id=root \</span><br><span class="line">-device virtio-blk,drive=root,id=d_root \</span><br><span class="line">-net nic,model=virtio,macaddr=00:11:22:33:44:55 \</span><br><span class="line">-net bridge,br=virbr0 \</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="5-创建根文件系统的拷贝"><a href="#5-创建根文件系统的拷贝" class="headerlink" title="5. 创建根文件系统的拷贝"></a>5. 创建根文件系统的拷贝</h1><ol>
<li><p>首先进入rootfs文件夹，之后创建base_img并且将其它脚本文件移入到base_img文件夹。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd ./rootfs</span><br><span class="line">mkdir base_img</span><br><span class="line">mv * ./base_img</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建两个新的文件夹用于装载新的镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir 2.bullseye</span><br><span class="line">mkdir 3.bullseye</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动<a class="link" target="_blank" rel="noopener" href="https://github.com/mufiye/mufiye_backup/blob/master/kernel_environment/create-qcow2.sh">create-qcow2.sh<i class="fas fa-external-link-alt"></i></a>创建两个新的镜像并生成对应镜像的启动脚本start.sh（下面的代码块对脚本内容进行了提炼）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash create-qcow2.sh</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">create-qcow2.sh</span></span><br><span class="line">array=(2 3)</span><br><span class="line">image_type=bullseye</span><br><span class="line">dst_path=$(pwd)/../</span><br><span class="line"></span><br><span class="line">for element in $&#123;array[@]&#125;</span><br><span class="line">do</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">创建新的qcow2文件，相当于做了拷贝</span></span><br><span class="line">	qemu-img create -F qcow2 -b $(pwd)/$&#123;image_type&#125;.qcow2 -f qcow2  \ 	                  					$&#123;dst_path&#125;$&#123;element&#125;.$&#123;image_type&#125;/image.qcow2</span><br><span class="line"><span class="meta prompt_">	</span></span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">复制启动虚拟机的文件并做了一些修改</span></span><br><span class="line">	cp update-image.sh $&#123;dst_path&#125;/$&#123;element&#125;.$&#123;image_type&#125;/start.sh</span><br><span class="line"><span class="meta prompt_">	</span></span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">修改mac地址</span></span><br><span class="line">	format_num=$(printf &quot;%02d\n&quot; $&#123;element&#125;)</span><br><span class="line">	sed -i &quot;s/00:11:22:33:44:55/00:11:22:33:44:$&#123;format_num&#125;/g&quot; \      				                      $&#123;dst_path&#125;/$&#123;element&#125;.$&#123;image_type&#125;/start.sh</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">修改-drive file后跟的虚拟磁盘参数</span></span><br><span class="line">	sed -i &quot;s/$&#123;image_type&#125;.qcow2/image.qcow2/g&quot; \                                                        $&#123;dst_path&#125;/$&#123;element&#125;.$&#123;image_type&#125;/start.sh</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">启动虚拟机时使其挂载两份额外的文件(放到之后介绍)</span></span><br><span class="line">	...</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">启动用于gdb调试的端口</span></span><br><span class="line">	gdb_port=`expr 5550 + $element`</span><br><span class="line">	echo &quot;-gdb tcp::$&#123;gdb_port&#125; \\&quot; &gt;&gt; $&#123;dst_path&#125;/$&#123;element&#125;.$&#123;image_type&#125;/start.sh</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
</li>
<li><p>进入到2.bullseye文件夹和3.bullseye文件夹并且为文件预分配空间</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fallocate -l 5G 1</span><br><span class="line">fallocate -l 5G nvme</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行start.sh文件启动qemu虚拟机</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash start.sh</span><br></pre></td></tr></table></figure>
<p>关于新的设备以及驱动设置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-drive和-device参数在上面的update_image.sh已经进行了介绍</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">相当于新创建的虚拟机连接有两个新的设备，分别是scsi协议的硬盘和nvme协议的硬盘，设备的磁盘映像分别为之前分配的1文件和nvme文件</span></span><br><span class="line">-drive file=1,if=none,format=raw,cache=writeback,file.locking=off,id=dd_1 \</span><br><span class="line">-device scsi-hd,drive=dd_1,id=disk_1 \</span><br><span class="line">-drive file=nvme,if=none,format=raw,cache=writeback,file.locking=off,id=b_nvme_1 \</span><br><span class="line">-device nvme,drive=b_nvme_1,serial=d_b_nvme_1 \</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="6-gdb调试环境配置"><a href="#6-gdb调试环境配置" class="headerlink" title="6. gdb调试环境配置"></a>6. gdb调试环境配置</h1><h2 id="6-1-配置gdb辅助调试功能"><a href="#6-1-配置gdb辅助调试功能" class="headerlink" title="6.1 配置gdb辅助调试功能"></a>6.1 配置gdb辅助调试功能</h2><h3 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h3><ol>
<li><p>向该文件~&#x2F;.gdbinit输入内容</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;source /home/mufiye/.gdb-linux/vmlinux-gdb.py&quot; &gt; ~/.gdbinit</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建文件夹</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~/.gdb-linux/</span><br></pre></td></tr></table></figure>
</li>
<li><p>在linux源码文件夹中运行make命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make scripts_gdb</span><br></pre></td></tr></table></figure>
</li>
<li><p>复制文件到gdb-linux目录下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp -r scripts/gdb/* ~/.gdb-linux/</span><br></pre></td></tr></table></figure>
</li>
<li><p>向该文件输入内容</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">输入的内容：sys.path.insert(0, <span class="string">&quot;/home/mufiye/.gdb-linux&quot;</span>)</span></span><br><span class="line">vim ~/.gdb-linux/vmlinux-gdb.py</span><br></pre></td></tr></table></figure>
</li>
<li><p>验证GDB辅助调试功能是否配置成功，用gdb vmlinux启动gdb后输入下面命令会有相关的提示</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) apropos lx</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h3><ol>
<li><p>向该文件~&#x2F;.gdbinit输入内容</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;add-auto-load-safe-path /home/mufiye/mufiye_kernel/linux-kernel/scripts/gdb/vmlinux-gdb.py&quot; &gt; ~/.gdbinit</span><br></pre></td></tr></table></figure>
</li>
<li><p>在linux源码文件夹中运行make命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make scripts_gdb</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="6-2-启动gdb调试"><a href="#6-2-启动gdb调试" class="headerlink" title="6.2 启动gdb调试"></a>6.2 启动gdb调试</h2><ol>
<li><p>gdb调试启动（在物理机上启动，之后远程连接虚拟机）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb vmlinux</span><br></pre></td></tr></table></figure>
</li>
<li><p>gdb远程连接qemu虚拟机（5552为端口号，这与启动qemu虚拟机时的设置有关）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">target remote:5552</span><br></pre></td></tr></table></figure>
</li>
<li><p>之后就可以使用gdb进行调试了</p>
</li>
</ol>
<h2 id="6-3-gdb调试遇到的问题以及成功截图"><a href="#6-3-gdb调试遇到的问题以及成功截图" class="headerlink" title="6.3 gdb调试遇到的问题以及成功截图"></a>6.3 gdb调试遇到的问题以及成功截图</h2><h3 id="问题1"><a href="#问题1" class="headerlink" title="问题1"></a>问题1</h3><p>第一个问题是不管何时都无法插入断点，无法读取内存内容，插入断点后函数内容为??()。该问题在gdb界面的错误提示为cannot insert breakpoint，cannot access memory adresss，我是在用break命令插入断点执行continue时遇到的该错误提示，同时插入断点时函数内容为??()。遇到该问题首先要考虑是否配置对了内核配置选项（见上面内核编译config配置），之后看看是否在用qemu启动内核时加入了nokaslr选项。</p>
<h3 id="问题2"><a href="#问题2" class="headerlink" title="问题2"></a>问题2</h3><p>第二个问题是在内核启动前无法插入断点，无法读取内存内容。在这种情况下，插入断点函数内容不为??()，在内核启动后插入断点一切正常，但是在内核启动前插入断点并continue，仍然出现cannot insert breakpoint，cannot access memory adresss的错误提示。此时我尝试使用hbreak，我发现使用hbreak不会发生错误并能够正常断点。</p>
<p>关于hbreak和break的区别，我查阅资料得知：break设置的是软件断点，由非法指令异常实现（软件实现），其中断的程序位于内存中；hbreak设置的是硬件端点，由硬件特性实现，其中断的程序位于只读寄存器中。当代码位于只读寄存器时，只能通过硬件断点调试。所以我猜测是内核启动过程中，start_kernel这段程序被加载到只读寄存器中，因此只能通过hbreak进行断点。</p>
<h3 id="gdb配置成功截图"><a href="#gdb配置成功截图" class="headerlink" title="gdb配置成功截图"></a>gdb配置成功截图</h3><img src="/images/gdb-success2.png" alt="gdb-success2" style="zoom:90%;">

<center>gdb调试，成功断点start_kernel函数</center>


<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a class="link" target="_blank" rel="noopener" href="https://github.com/chenxiaosonggithub/blog">https://github.com/chenxiaosonggithub/blog<i class="fas fa-external-link-alt"></i></a></li>
<li>《Linux内核设计与实现》</li>
<li><a class="link" target="_blank" rel="noopener" href="https://www.kernel.org/doc/htmldocs/kgdb/CompilingAKernel.html">https://www.kernel.org/doc/htmldocs/kgdb/CompilingAKernel.html<i class="fas fa-external-link-alt"></i></a></li>
<li><a class="link" target="_blank" rel="noopener" href="https://qemu.readthedocs.io/en/latest/system/quickstart.html">qemu官方文档<i class="fas fa-external-link-alt"></i></a></li>
<li><a class="link" target="_blank" rel="noopener" href="https://drewdevault.com/2018/09/10/Getting-started-with-qemu.html">Getting started with qemu<i class="fas fa-external-link-alt"></i></a></li>
<li><a class="link" target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/dev-tools/gdb-kernel-debugging.rst">Debugging kernel and modules via gdb<i class="fas fa-external-link-alt"></i></a></li>
<li><a class="link" target="_blank" rel="noopener" href="https://sourceware.org/gdb/current/onlinedocs/gdb/">GDB官方文档<i class="fas fa-external-link-alt"></i></a></li>
<li><a class="link" target="_blank" rel="noopener" href="https://blog.csdn.net/jasonLee_lijiaqi/article/details/80967912">QEMU+gdb调试Linux内核全过程<i class="fas fa-external-link-alt"></i></a></li>
<li><a class="link" target="_blank" rel="noopener" href="https://s3.shizhz.me/s3e1">linux kernel调试环境<i class="fas fa-external-link-alt"></i></a></li>
<li><a class="link" target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/363827057">linux内存子系统 - qemu调试linux 内核启动<i class="fas fa-external-link-alt"></i></a></li>
<li><a class="link" target="_blank" rel="noopener" href="https://sourceware.org/legacy-ml/gdb/2016-08/msg00014.html">https://sourceware.org/legacy-ml/gdb/2016-08/msg00014.html<i class="fas fa-external-link-alt"></i></a></li>
<li><a class="link" target="_blank" rel="noopener" href="https://linux.cn/forum.php?mod=viewthread&tid=16243">关于linux内核kgdb调试<i class="fas fa-external-link-alt"></i></a></li>
<li><a class="link" target="_blank" rel="noopener" href="https://blog.51cto.com/u_11134889/2083650">关于hbreak和break<i class="fas fa-external-link-alt"></i></a></li>
</ol>

        </div>

        
            <div class="post-copyright-info">
                <div class="article-copyright-info-container">
    <ul>
        <li>本文标题：内核编译、启动以及gdb内核调试环境构建</li>
        <li>本文作者：mufiye</li>
        <li>创建时间：2022-05-31 16:58:17</li>
        <li>
            本文链接：http://mufiye.github.io/2022/05/31/内核编译、启动以及gdb内核调试环境构建/
        </li>
        <li>
            版权声明：本博客所有文章除特别声明外，均采用 <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> 许可协议。转载请注明出处！
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/gdb/">#gdb</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">#环境搭建</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/%E5%86%85%E6%A0%B8%E7%BC%96%E8%AF%91/">#内核编译</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/qemu/">#qemu</a>&nbsp;
                    </li>
                
            </ul>
        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2022/05/31/nfs%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">nfs环境搭建</span>
                                <span class="post-nav-item">上一篇</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2021/11/28/gdb%E5%85%A5%E9%97%A8%E7%B3%BB%E5%88%975/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">gdb入门系列5</span>
                                <span class="post-nav-item">下一篇</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
            <div class="comment-container">
                <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        <i class="fas fa-comments">&nbsp;评论</i>
    </div>
    

        
            
    <div id="gitalk-container"></div>
    <script 
            src="//cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js"></script>
    <script >

        function loadGitalk() {
            let __gitalk__pathname = decodeURI(location.pathname);
            const __gitalk__pathnameLength = __gitalk__pathname.length;
            const __gitalk__pathnameMaxLength = 50;
            if (__gitalk__pathnameLength > __gitalk__pathnameMaxLength) {
                __gitalk__pathname = __gitalk__pathname.substring(0, __gitalk__pathnameMaxLength - 3) + '...';
            }

            try {
                Gitalk && new Gitalk({
                    clientID: '51136a001a6f1e0b7f45',
                    clientSecret: '723f7c05d0a3b94c21246d7494fb74962fbd6248',
                    repo: 'mufiye_blog-gitalk-comments-repo',
                    owner: 'mufiye',
                    admin: ['mufiye'],
                    id: __gitalk__pathname,
                    language: 'zh-CN'
                }).render('gitalk-container');

            } catch (e) {
                window.Gitalk = null;
            }
        }

        if ('false') {
            const loadGitalkTimeout = setTimeout(() => {
                loadGitalk();
                clearTimeout(loadGitalkTimeout);
            }, 1000);
        } else {
            window.addEventListener('DOMContentLoaded', loadGitalk);
        }
    </script>



        
    
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2022</span>
              -
            
            2024&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">mufiye</a>
        </div>
        
            <script async  src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        访问人数&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
                    <span id="busuanzi_container_site_pv">
                        总访问量&nbsp;<span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            由 <a target="_blank" href="https://hexo.io">Hexo</a> 驱动&nbsp;|&nbsp;主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.5</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fas fa-comment"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-%E7%9B%B8%E5%85%B3%E8%BD%AF%E4%BB%B6%E5%8C%85%E7%8E%AF%E5%A2%83%E4%BB%A5%E5%8F%8A%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="nav-text">1. 相关软件包环境以及目录结构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-%E7%BC%96%E8%AF%91%E5%86%85%E6%A0%B8"><span class="nav-text">2. 编译内核</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-%E5%88%B6%E4%BD%9C%E6%A0%B9%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="nav-text">3. 制作根文件系统</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-%E5%AE%89%E8%A3%85%E5%B9%B6%E4%B8%94%E9%85%8D%E7%BD%AEqemu"><span class="nav-text">4. 安装并且配置qemu</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-%E5%88%9B%E5%BB%BA%E6%A0%B9%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%8B%B7%E8%B4%9D"><span class="nav-text">5. 创建根文件系统的拷贝</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-gdb%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="nav-text">6. gdb调试环境配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1-%E9%85%8D%E7%BD%AEgdb%E8%BE%85%E5%8A%A9%E8%B0%83%E8%AF%95%E5%8A%9F%E8%83%BD"><span class="nav-text">6.1 配置gdb辅助调试功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80"><span class="nav-text">方法一</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C"><span class="nav-text">方法二</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2-%E5%90%AF%E5%8A%A8gdb%E8%B0%83%E8%AF%95"><span class="nav-text">6.2 启动gdb调试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-3-gdb%E8%B0%83%E8%AF%95%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98%E4%BB%A5%E5%8F%8A%E6%88%90%E5%8A%9F%E6%88%AA%E5%9B%BE"><span class="nav-text">6.3 gdb调试遇到的问题以及成功截图</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%981"><span class="nav-text">问题1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%982"><span class="nav-text">问题2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gdb%E9%85%8D%E7%BD%AE%E6%88%90%E5%8A%9F%E6%88%AA%E5%9B%BE"><span class="nav-text">gdb配置成功截图</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-text">参考</span></a></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>



<script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/dark-light-toggle.js"></script>


    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/local-search.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/code-copy.js"></script>




<div class="post-scripts">
    
        <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/left-side-toggle.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/libs/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/toc.js"></script>
    
</div>



</body>
</html>
